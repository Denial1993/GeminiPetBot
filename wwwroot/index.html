<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini å¯µç‰©æ™ºèƒ½åŠ©æ‰‹ MVP</title>
    <style>
        /* (ä¿ç•™åŸæœ¬æ¨£å¼ï¼Œæ–°å¢ select æ¨£å¼) */
        :root { --bg-color: #1a1a1a; --chat-bg: #2d2d2d; --user-msg-bg: #007bff; --ai-msg-bg: #383838; --text-color: #e0e0e0; --accent-color: #4caf50; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; justify-content: center; height: 100vh; }
        .chat-container { width: 100%; max-width: 800px; background-color: var(--chat-bg); display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .header { padding: 20px; background-color: #202020; border-bottom: 1px solid #444; text-align: center; }
        .header h2 { margin: 0; color: var(--accent-color); }
        .header p { margin: 5px 0 0; font-size: 0.9em; color: #888; }
        #chat-history { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 12px 16px; border-radius: 15px; line-height: 1.5; position: relative; }
        .message.user { align-self: flex-end; background-color: var(--user-msg-bg); border-bottom-right-radius: 2px; }
        .message.ai { align-self: flex-start; background-color: var(--ai-msg-bg); border-bottom-left-radius: 2px; }
        .citation-box { margin-top: 10px; padding-top: 10px; border-top: 1px solid #555; font-size: 0.85em; color: #aaa; }
        .citation-badge { display: inline-block; background-color: #444; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-size: 0.8em; border: 1px solid #555; }
        .risk-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-weight: bold; font-size: 0.8em; margin-bottom: 5px; }
        .risk-high { background-color: #ff4444; color: white; }
        .risk-medium { background-color: #ffbb33; color: black; }
        .input-area { padding: 20px; background-color: #202020; display: flex; flex-direction: column; gap: 10px; }
        .controls { display: flex; gap: 10px; }
        
        /* æ–°å¢ï¼šç‰©ç¨®é¸æ“‡å™¨æ¨£å¼ */
        select { background-color: #333; color: white; border: 1px solid #444; padding: 10px; border-radius: 25px; outline: none; cursor: pointer; }
        
        .input-row { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #444; background-color: #333; color: white; outline: none; }
        button { padding: 10px 20px; border-radius: 25px; border: none; background-color: var(--accent-color); color: white; cursor: pointer; font-weight: bold; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .typing-indicator { font-style: italic; color: #888; font-size: 0.9em; margin-left: 10px; display: none;}
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <h2>ğŸ¶ Gemini å¯µç‰©é†«ç™‚åŠ©æ‰‹</h2>
        <p>ä¾æ“šå…¬å¸å…§éƒ¨ PDF çŸ¥è­˜åº«å›ç­” (MVP Demo)</p>
    </div>

    <div id="chat-history">
        <div class="message ai">
            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å¯µç‰©åŠ©æ‰‹ã€‚è«‹å…ˆé¸æ“‡æ‚¨çš„å¯µç‰©ç¨®é¡ï¼Œå†è©¢å•å•é¡Œã€‚
        </div>
    </div>

    <div style="padding: 0 20px;">
        <span id="typing" class="typing-indicator">AI æ­£åœ¨æŸ¥è©¢çŸ¥è­˜åº«...</span>
    </div>

    <div class="input-area">
        <div class="controls">
            <select id="pet-species">
                <option value="dog">ğŸ¶ ç‹—ç‹—</option>
                <option value="cat">ğŸ± è²“å’ª</option>
            </select>
        </div>
        <div class="input-row">
            <input type="text" id="user-input" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" id="send-btn">ç™¼é€</button>
        </div>
    </div>
</div>

<script>
    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const speciesSelect = document.getElementById('pet-species'); // æŠ“å–é¸æ“‡çš„ç‰©ç¨®
        const sendBtn = document.getElementById('send-btn');
        const message = inputField.value.trim();
        
        if (!message) return;

        // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
        appendMessage(message, 'user');
        inputField.value = '';
        inputField.disabled = true;
        sendBtn.disabled = true;
        document.getElementById('typing').style.display = 'block';

        try {
            // å‘¼å« API
            const response = await fetch('/Chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: "web_user",
                    pet_profile: { 
                        species: speciesSelect.value, // â˜… é€™è£¡å‹•æ…‹å¸¶å…¥ user é¸çš„å€¼
                        age: 3, 
                        weight: 5 
                    }, 
                    message: message
                })
            });

            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            appendAIMessage(data);

        } catch (error) {
            appendMessage("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦å•Ÿå‹•ã€‚", 'ai');
        } finally {
            inputField.disabled = false;
            sendBtn.disabled = false;
            inputField.focus();
            document.getElementById('typing').style.display = 'none';
        }
    }

    function appendMessage(text, sender) {
        const history = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.textContent = text;
        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
    }

    function appendAIMessage(data) {
        const history = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = 'message ai';

        let riskHtml = '';
        if (data.risk_level === 'high') riskHtml = `<div class="risk-badge risk-high">âš ï¸ é«˜é¢¨éšª - å»ºè­°å°±é†«</div>`;
        else if (data.risk_level === 'medium') riskHtml = `<div class="risk-badge risk-medium">âš ï¸ æ³¨æ„è§€å¯Ÿ</div>`;

        let citationsHtml = '';
        if (data.citations && data.citations.length > 0) {
            citationsHtml = `<div class="citation-box">ğŸ“š åƒè€ƒä¾†æºï¼š<br>${data.citations.map(c => `<span class="citation-badge">${c}</span>`).join('')}</div>`;
        }

        div.innerHTML = `${riskHtml}<div>${data.answer}</div>${citationsHtml}`;
        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
    }

    function handleKeyPress(event) { if (event.key === 'Enter') sendMessage(); }
</script>
</body>
</html>